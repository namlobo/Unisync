USE UNISYNCDB;
-- BASIC CRUD OPERATIONS (Student Table)

-- CREATE
INSERT INTO Student (SRN, FirstName, LastName, Email, Phone, Department, JoinDate, Password) 
VALUES ('PES2UG23CS999', 'Test', 'User', 'test.user@unisync.edu', '9000000999', 
        'Computer Science', '2023-09-01', 'testpass');

-- READ
SELECT * FROM Student WHERE SRN = 'PES2UG23CS999';

-- UPDATE
UPDATE Student SET Department = 'Biotechnology' WHERE SRN = 'PES2UG23CS999';
SELECT SRN, FirstName, Department FROM Student WHERE SRN = 'PES2UG23CS999';

-- DELETE
DELETE FROM Student WHERE SRN = 'PES2UG23CS999';
SELECT * FROM Student WHERE SRN = 'PES2UG23CS999';



-- Create fresh test students
INSERT INTO Student (SRN, FirstName, LastName, Email, Phone, Department, JoinDate, Password)
VALUES 
('PES2UG23CS550', 'John', 'd'souza', 'seller550@unisync.edu', '9000000550', 'CSE', '2025-01-01', 'demo550'),
('PES2UG23CS551', 'Mary', 'Mathur', 'lender551@unisync.edu', '9000000551', 'ISE', '2025-01-01', 'demo551'),
('PES2UG23CS555', 'Test', 'uncle', 'buyer555@unisync.edu', '9000000555', 'Electronics', '2025-01-01', 'demo555');

-- Create a resource that can be sold to the new student
INSERT INTO Resource (Title, Description, itemCondition, Status, ListingType, OwnerID, CategoryID)
VALUES ('Python Programming Book', 'Latest edition, 2024', 'Good', 'Available', 'Sell', 'PES2UG23CS550', 1);

SET @sell_resource := LAST_INSERT_ID();

-- Add a BuySell transaction for this new student
INSERT INTO Transactions (Type) VALUES ('BuySell');
SET @buy_trans := LAST_INSERT_ID();

INSERT INTO BuySell (ItemID, SellerID, BuyerID, Price, Status, TransactionDate, TransactionID)
VALUES (@sell_resource, 'PES2UG23CS550', 'PES2UG23CS555', 800.00, 'Completed', '2025-11-06', @buy_trans);

-- Verify sale and trigger effect
SELECT 'BuySell Completed' AS Step, ResourceID, Status FROM Resource WHERE ResourceID = @sell_resource;


-- Create a resource that can be borrowed by this student
INSERT INTO Resource (Title, Description, itemCondition, Status, ListingType, OwnerID, CategoryID)
VALUES ('DBMS Reference Book', 'For semester 5', 'Excellent', 'Available', 'Lend', 'PES2UG23CS551', 1);

SET @lend_item := LAST_INSERT_ID();

-- Create lend transaction for the new student
CALL initiate_lend(@lend_item, 'PES2UG23CS551', 'PES2UG23CS555', '2025-11-01', '2025-11-05', @lend_demo);

-- Complete it to mark as finished (so it appears in nested queries)
CALL complete_lend(@lend_demo);

-- Verify that borrow was completed and resource returned
SELECT 'Borrow Completed' AS Step, ResourceID, Status FROM Resource WHERE ResourceID = @lend_item;


-- Create a review for one of the completed items
INSERT INTO Review (Rating, Comments, STD_ID, ItemID)
VALUES (5, 'Very helpful book!', 'PES2UG23CS555', @sell_resource);

-- Add another review by same student on different item for variety
INSERT INTO Review (Rating, Comments, STD_ID, ItemID)
VALUES (4, 'Useful for DB concepts.', 'PES2UG23CS555', @lend_item);


-- Now rerun the three key queries again for this new student

-- JOIN QUERY
SELECT 
    r.ResourceID, 
    r.Title, 
    r.Description, 
    bs.Price, 
    CONCAT(s.FirstName, ' ', s.LastName) AS SellerName, 
    r.Status
FROM Resource r
JOIN Student s ON r.OwnerID = s.SRN
JOIN BuySell bs ON r.ResourceID = bs.ItemID
WHERE r.ListingType = 'Sell' 
  AND bs.Status IN ('Listed', 'PendingPayment', 'Completed');

-- NESTED QUERY
SELECT DISTINCT r.ResourceID, r.Title
FROM Resource r
JOIN LendBorrow lb ON r.ResourceID = lb.ItemID 
WHERE lb.BorrowerID = 'PES2UG23CS555' 
  AND lb.Status = 'Completed' 
  AND r.ResourceID NOT IN (
      SELECT rv.ItemID FROM Review rv WHERE rv.STD_ID = 'PES2UG23CS555'
  )
UNION
SELECT DISTINCT r.ResourceID, r.Title
FROM Resource r
JOIN BuySell bs ON r.ResourceID = bs.ItemID 
WHERE bs.BuyerID = 'PES2UG23CS555' 
  AND bs.Status = 'Completed' 
  AND r.ResourceID NOT IN (
      SELECT rv.ItemID FROM Review rv WHERE rv.STD_ID = 'PES2UG23CS555'
  );

-- AGGREGATE QUERY
SELECT 
    r.Title, 
    ROUND(AVG(rv.Rating), 2) AS AverageRating, 
    COUNT(rv.ReviewID) AS TotalReviews
FROM Resource r
LEFT JOIN Review rv ON r.ResourceID = rv.ItemID
GROUP BY r.ResourceID, r.Title
ORDER BY AverageRating DESC;
